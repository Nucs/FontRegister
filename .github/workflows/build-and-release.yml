name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags: [ "release/v*" ]
  pull_request:
    branches: [ "main" ]

permissions: write-all

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: |
          6.0.x
          8.0.x

    - name: Restore dependencies
      run: dotnet restore FontRegister.sln
      
    - name: Build
      run: dotnet build FontRegister.sln --configuration Release --no-restore
      
    - name: Test
      run: dotnet test FontRegister.sln --configuration Release --no-build --verbosity normal --logger trx --collect:"XPlat Code Coverage"
      
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: ${{ github.workspace }}/**/TestResults/**/*
        retention-days: 5

    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: "**/*.trx"

  publish:
    needs: build
    if: startsWith(github.ref, 'refs/tags/release/v')
    runs-on: windows-latest
    strategy:
      matrix:
        framework: ['net48', 'net6.0-windows', 'net8.0-windows']
        runtime: ['win-x64', 'win-x86']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: |
          6.0.x
          8.0.x
          
    - name: Publish
      run: |
        dotnet publish FontRegister/FontRegister.csproj `
          --configuration Release `
          --framework ${{ matrix.framework }} `
          --runtime ${{ matrix.runtime }} `
          --self-contained true `
          -p:PublishSingleFile=true `
          --output publish/${{ matrix.framework }}/${{ matrix.runtime }}
      
    - name: Create ZIP Archive
      run: |
        Compress-Archive -Path "publish/${{ matrix.framework }}/${{ matrix.runtime }}/*" `
          -DestinationPath "FontRegister-${{ matrix.framework }}-${{ matrix.runtime }}.zip"
      
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FontRegister-${{ matrix.framework }}-${{ matrix.runtime }}
        path: FontRegister-${{ matrix.framework }}-${{ matrix.runtime }}.zip
        retention-days: 5

  create-release:
    needs: publish
    if: startsWith(github.ref, 'refs/tags/release/v')
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: FontRegister-*
        merge-multiple: true
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: FontRegister-*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
